name: ðŸ“¦ å‘å¸ƒ Obsidian Git ä¸­æ–‡ç‰ˆ

on:
  push:
    tags:
      - "v*"  # åŒ¹é…ç‰ˆæœ¬æ ‡ç­¾ï¼Œå¦‚ v2.36.1
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: 2.36.1)'
        required: true
        default: 'latest'

env:
  PLUGIN_ID: git-zh
  PLUGIN_NAME: obsidian-git-zh

permissions:
  contents: write

jobs:
  publish:
    name: ðŸ“¦ å‘å¸ƒæ’ä»¶
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ“¦ è®¾ç½® pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: ðŸ› ï¸ å®‰è£…ç³»ç»Ÿä¾èµ–
        run: sudo apt-get update && sudo apt-get install -y zip

      - name: ðŸ”§ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: ðŸ“š å®‰è£…ä¾èµ–
        run: pnpm install

      - name: ðŸ” å‘å¸ƒå‰éªŒè¯
        run: |
          echo "ðŸ” æ‰§è¡Œå‘å¸ƒå‰æ£€æŸ¥..."
          pnpm run pre-release
          echo "âœ… å‘å¸ƒå‰éªŒè¯é€šè¿‡"

      - name: ðŸ“¦ ç”Ÿæˆå‘å¸ƒåŒ…
        run: |
          echo "ðŸ“¦ ç”Ÿæˆç¬¦åˆObsidianæ ‡å‡†çš„å‘å¸ƒåŒ…..."
          pnpm run package:obsidian

          # é‡å‘½åå‘å¸ƒåŒ…
          VERSION="${{ github.event.inputs.version || github.ref_name }}"
          VERSION="${VERSION#v}"  # ç§»é™¤ v å‰ç¼€
          mv git-zh.zip "${PLUGIN_NAME}-${VERSION}.zip"

          echo "âœ… å‘å¸ƒåŒ…ç”Ÿæˆå®Œæˆ: ${PLUGIN_NAME}-${VERSION}.zip"
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: ðŸ“Š éªŒè¯å‘å¸ƒåŒ…
        run: |
          echo "ðŸ“¦ éªŒè¯å‘å¸ƒåŒ…ç»“æž„..."
          ls -la *.zip

          echo ""
          echo "ðŸ“ æ£€æŸ¥å‘å¸ƒåŒ…å†…å®¹:"
          unzip -l "${PLUGIN_NAME}-${VERSION}.zip" | head -20

          echo ""
          echo "ðŸ“ éªŒè¯æ’ä»¶æ–‡ä»¶å¤¹ç»“æž„:"
          unzip -l "${PLUGIN_NAME}-${VERSION}.zip" | grep "${PLUGIN_ID}/" || exit 1
          echo "âœ… å‘å¸ƒåŒ…ç»“æž„éªŒè¯é€šè¿‡"

      - name: ðŸš€ åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref }}
          name: ðŸŒŸ Obsidian Git ä¸­æ–‡ç‰ˆ ${VERSION}
          body: |
            ## ðŸŒŸ Obsidian Git ä¸­æ–‡ç‰ˆ ${VERSION}

            ### âœ¨ ä¸»è¦ç‰¹æ€§
            - ðŸ‡¨ðŸ‡³ **å®Œæ•´ä¸­æ–‡ç•Œé¢** - æ‰€æœ‰å‘½ä»¤ã€è®¾ç½®ã€é€šçŸ¥å‡å·²ç¿»è¯‘ (220+ ç¿»è¯‘é”®)
            - ðŸŒ **æ™ºèƒ½è¯­è¨€åˆ‡æ¢** - æ”¯æŒä¸­è‹±æ–‡è‡ªç”±åˆ‡æ¢
            - ðŸ”„ **è‡ªåŠ¨å¤‡ä»½åŒæ­¥** - å®šæ—¶è‡ªåŠ¨æäº¤å’ŒåŒæ­¥
            - ðŸ“Š **å¯è§†åŒ–ç®¡ç†** - æºä»£ç ç®¡ç†è§†å›¾ã€åŽ†å²è®°å½•è§†å›¾ã€å·®å¼‚è§†å›¾
            - ðŸ‘¤ **è¡Œä½œè€…åŠŸèƒ½** - æŸ¥çœ‹æ¯ä¸€è¡Œä»£ç çš„æœ€åŽä¿®æ”¹è€…ä¿¡æ¯
            - ðŸ“± **ç§»åŠ¨ç«¯ä¼˜åŒ–** - ç§»åŠ¨è®¾å¤‡æ€§èƒ½ä¼˜åŒ–å’Œè§¦æ‘¸å‹å¥½ç•Œé¢
            - âš™ï¸ **çµæ´»é…ç½®** - ä¸°å¯Œçš„è®¾ç½®é€‰é¡¹æ»¡è¶³ä¸åŒéœ€æ±‚

            ### ðŸ“¦ å®‰è£…æ–¹æ³•

            **æŽ¨èæ–¹å¼ï¼šä¸€é”®å®‰è£…**
            1. ä¸‹è½½ `${{ env.PLUGIN_NAME }}-${VERSION}.zip`
            2. è§£åŽ‹åˆ°æ‚¨çš„ Obsidian æ’ä»¶ç›®å½•ï¼š
               - Windows: `%APPDATA%\\Obsidian\\Plugins\\`
               - macOS: `~/Library/Application Support/obsidian/Plugins/`
               - Linux: `~/.config/obsidian/Plugins/`
            3. é‡å¯ Obsidianï¼Œåœ¨è®¾ç½®ä¸­å¯ç”¨ "Git ä¸­æ–‡ç‰ˆ" æ’ä»¶

            ### ðŸ“‹ æ’ä»¶ä¿¡æ¯
            - **æ’ä»¶ID**: `${{ env.PLUGIN_ID }}`
            - **ç‰ˆæœ¬**: ${VERSION}
            - **åŸºäºŽåŽŸç‰ˆ**: v2.36.1
            - **æœ€ä½ŽObsidianç‰ˆæœ¬**: 0.15.0
            - **æž„å»ºæ—¥æœŸ**: ${{ github.event.head_commit.timestamp }}

            ### ðŸ“Š æ–‡ä»¶æ ¡éªŒ
            ```bash
            # éªŒè¯æ–‡ä»¶å®Œæ•´æ€§
            unzip -l ${{ env.PLUGIN_NAME }}-${VERSION}.zip
            ```

            ### ðŸ”— ç›¸å…³é“¾æŽ¥
            - [ðŸ“– å®Œæ•´ä½¿ç”¨æŒ‡å—](${{ github.server_url }}/${{ github.repository }}/blob/master/README.md)
            - [ðŸš€ å¿«é€Ÿå¼€å§‹](${{ github.server_url }}/${{ github.repository }}/blob/master/docs/Getting%20Started.md)
            - [â“ å¸¸è§é—®é¢˜](${{ github.server_url }}/${{ github.repository }}/blob/master/docs/Common%20issues.md)
            - [ðŸŒŸ åŽŸç‰ˆé¡¹ç›®](https://github.com/Vinzent03/obsidian-git)

            ---
            **ðŸ’ å¦‚æžœè¿™ä¸ªæ’ä»¶å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè¯·è€ƒè™‘ç»™é¡¹ç›®ç‚¹ä¸ª â­ Starï¼**

            **ðŸ› å‘çŽ°é—®é¢˜ï¼Ÿ[æäº¤ Issue](${{ github.server_url }}/${{ github.repository }}/issues)**
          draft: false
          prerelease: false
          files: ${{ env.PLUGIN_NAME }}-${VERSION}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸŽ‰ å‘å¸ƒå®Œæˆé€šçŸ¥
        run: |
          echo "## ðŸŽ‰ å‘å¸ƒæˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ å‘å¸ƒä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: ${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "- **å‘å¸ƒæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **å‘å¸ƒåŒ…**: ${{ env.PLUGIN_NAME }}-${VERSION}.zip" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— ä¸‹è½½é“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Releases](${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**âœ… æ’ä»¶å·²æˆåŠŸå‘å¸ƒåˆ° Obsidian ç¤¾åŒºï¼** ðŸŽŠ" >> $GITHUB_STEP_SUMMARY