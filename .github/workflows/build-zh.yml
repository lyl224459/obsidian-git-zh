name: æ„å»ºæµ‹è¯•ï¼ˆä¸­æ–‡ç‰ˆï¼‰

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  build:
    name: ğŸ”¨ æ„å»ºæµ‹è¯•
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ è®¾ç½® pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: ğŸ”§ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: ğŸ“š å®‰è£…ä¾èµ–
        run: pnpm install

      - name: ğŸ”¨ æ„å»ºé¡¹ç›®
        run: |
          echo "ğŸ”¨ æ„å»º Obsidian Git ä¸­æ–‡ç‰ˆ..."
          pnpm run build
          echo "âœ… æ„å»ºå®Œæˆï¼"

      - name: ğŸ“¦ ç”Ÿæˆå‘å¸ƒåŒ…
        run: |
          echo "ğŸ“¦ ç”Ÿæˆç¬¦åˆObsidianæ ‡å‡†çš„å‘å¸ƒåŒ…..."
          pnpm run package:obsidian
          echo "âœ… å‘å¸ƒåŒ…ç”Ÿæˆå®Œæˆï¼"

      - name: ğŸ“Š éªŒè¯æ„å»ºå’Œå‘å¸ƒåŒ…
        run: |
          echo "ğŸ“¦ æ£€æŸ¥æ„å»ºæ–‡ä»¶..."
          test -f dist/main.js && echo "âœ… main.js å­˜åœ¨" || exit 1
          test -f dist/manifest.json && echo "âœ… manifest.json å­˜åœ¨" || exit 1
          test -f dist/styles.css && echo "âœ… styles.css å­˜åœ¨" || exit 1
          test -f dist/LICENSE && echo "âœ… LICENSE å­˜åœ¨" || exit 1
          test -f dist/README.md && echo "âœ… README.md å­˜åœ¨" || exit 1

          echo ""
          echo "ğŸ“¦ æ£€æŸ¥å‘å¸ƒåŒ…..."
          test -f git-zh.zip && echo "âœ… git-zh.zip å­˜åœ¨" || exit 1

          echo ""
          echo "ğŸ“ éªŒè¯å‘å¸ƒåŒ…ç»“æ„..."
          unzip -l git-zh.zip | grep -E "(git-zh/|main.js|manifest.json|styles.css)" || exit 1
          echo "âœ… å‘å¸ƒåŒ…ç»“æ„æ­£ç¡®ï¼"

          echo ""
          echo "ğŸ“ æ–‡ä»¶å¤§å°:"
          ls -lh dist/
          ls -lh git-zh.zip

          echo ""
          echo "âœ… æ‰€æœ‰æ„å»ºå’Œå‘å¸ƒæ–‡ä»¶éªŒè¯é€šè¿‡ï¼"

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: obsidian-git-zh-build
          path: dist/
          retention-days: 7

      - name: ğŸ“¤ ä¸Šä¼ å‘å¸ƒåŒ…
        uses: actions/upload-artifact@v4
        with:
          name: obsidian-git-zh-release
          path: |
            git-zh.zip
            git-zh.tar.gz
          retention-days: 30

  lint:
    name: ğŸ” ä»£ç æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ è®¾ç½® pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: ğŸ”§ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: ğŸ“š å®‰è£…ä¾èµ–
        run: pnpm install

      - name: ğŸ” ESLint æ£€æŸ¥
        run: pnpm run lint
        continue-on-error: true

      - name: ğŸ’… Prettier æ ¼å¼æ£€æŸ¥
        run: pnpm run format
        continue-on-error: true

  type-check:
    name: ğŸ“ ç±»å‹æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ è®¾ç½® pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: ğŸ”§ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: ğŸ“š å®‰è£…ä¾èµ–
        run: pnpm install

      - name: ğŸ” Svelte æ£€æŸ¥
        run: pnpm run svelte
        continue-on-error: true
