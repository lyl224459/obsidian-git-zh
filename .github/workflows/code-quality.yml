name: ðŸ” ä»£ç è´¨é‡æ£€æŸ¥

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  schedule:
    # æ¯å‘¨ä¸€æ—©ä¸Š8ç‚¹è¿è¡Œ
    - cron: '0 8 * * 1'

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  # ðŸ“Š ä»£ç è´¨é‡åˆ†æž
  analyze:
    name: ðŸ“Š ä»£ç è´¨é‡åˆ†æž
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ è®¾ç½® pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: ðŸ”§ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: ðŸ“š å®‰è£…ä¾èµ–
        run: pnpm install

      - name: ðŸ“ ä»£ç ç»Ÿè®¡
        run: |
          echo "## ðŸ“Š ä»£ç ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ“ æ–‡ä»¶ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          find src -name "*.ts" -o -name "*.svelte" | wc -l | xargs echo "TypeScript/Svelte æ–‡ä»¶:" >> $GITHUB_STEP_SUMMARY
          find . -name "*.md" | wc -l | xargs echo "Markdown æ–‡ä»¶:" >> $GITHUB_STEP_SUMMARY
          find . -name "*.json" | wc -l | xargs echo "JSON é…ç½®æ–‡ä»¶:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ“ ä»£ç è¡Œæ•°ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          find src -name "*.ts" -exec wc -l {} + | tail -1 | awk '{print "TypeScript ä»£ç è¡Œæ•°:", $1}' >> $GITHUB_STEP_SUMMARY
          find src -name "*.svelte" -exec wc -l {} + | tail -1 | awk '{print "Svelte æ¨¡æ¿è¡Œæ•°:", $1}' >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # ðŸ” é™æ€ä»£ç åˆ†æž
  lint:
    name: ðŸ” é™æ€ä»£ç åˆ†æž
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ“¦ è®¾ç½® pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: ðŸ”§ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: ðŸ“š å®‰è£…ä¾èµ–
        run: pnpm install

      - name: ðŸ” ESLint æ£€æŸ¥
        run: |
          echo "ðŸ” è¿è¡Œ ESLint..."
          pnpm run lint 2>&1 || true

      - name: ðŸ’… Prettier æ£€æŸ¥
        run: |
          echo "ðŸ’… è¿è¡Œ Prettier..."
          pnpm run format 2>&1 || true

      - name: ðŸ“ TypeScript æ£€æŸ¥
        run: |
          echo "ðŸ“ è¿è¡Œ TypeScript æ£€æŸ¥..."
          pnpm run tsc 2>&1 || true

      - name: ðŸ”Ž Svelte æ£€æŸ¥
        run: |
          echo "ðŸ”Ž è¿è¡Œ Svelte æ£€æŸ¥..."
          pnpm run svelte 2>&1 || true

  # ðŸ§ª æž„å»ºéªŒè¯
  build-check:
    name: ðŸ§ª æž„å»ºéªŒè¯
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ“¦ è®¾ç½® pnpm
        uses: pnpm/action-setup@v2
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: ðŸ”§ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: ðŸ“š å®‰è£…ä¾èµ–
        run: pnpm install

      - name: ðŸ§ª æž„å»ºæµ‹è¯•
        run: |
          echo "ðŸ§ª æµ‹è¯•æž„å»ºè¿‡ç¨‹..."
          pnpm run build

          echo "ðŸ“¦ éªŒè¯æž„å»ºäº§ç‰©..."
          test -f dist/main.js && echo "âœ… main.js" || echo "âŒ main.js ç¼ºå¤±"
          test -f dist/manifest.json && echo "âœ… manifest.json" || echo "âŒ manifest.json ç¼ºå¤±"
          test -f dist/styles.css && echo "âœ… styles.css" || echo "âŒ styles.css ç¼ºå¤±"
          test -f dist/LICENSE && echo "âœ… LICENSE" || echo "âŒ LICENSE ç¼ºå¤±"
          test -f dist/README.md && echo "âœ… README.md" || echo "âŒ README.md ç¼ºå¤±"

      - name: ðŸ“¦ æ‰“åŒ…æµ‹è¯•
        run: |
          echo "ðŸ“¦ æµ‹è¯•æ‰“åŒ…è¿‡ç¨‹..."
          pnpm run package:obsidian

          echo "ðŸ“¦ éªŒè¯å‘å¸ƒåŒ…..."
          test -f git-zh.zip && echo "âœ… git-zh.zip" || echo "âŒ git-zh.zip ç¼ºå¤±"

          echo "ðŸ“ éªŒè¯å‘å¸ƒåŒ…ç»“æž„..."
          unzip -l git-zh.zip | grep "git-zh/" && echo "âœ… æ­£ç¡®çš„æ–‡ä»¶å¤¹ç»“æž„" || echo "âŒ æ–‡ä»¶å¤¹ç»“æž„é”™è¯¯"

  # ðŸ“Š å®‰å…¨æ£€æŸ¥
  security:
    name: ðŸ”’ å®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ”’ è¿è¡Œ Trivy æ¼æ´žæ‰«æ
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ðŸ“¤ ä¸Šä¼  Trivy æ‰«æç»“æžœ
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ðŸ“ˆ ä¾èµ–åˆ†æž
  dependencies:
    name: ðŸ“ˆ ä¾èµ–åˆ†æž
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ“¦ è®¾ç½® pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: ðŸ”§ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: ðŸ“Š åˆ†æžä¾èµ–
        run: |
          echo "## ðŸ“ˆ ä¾èµ–åˆ†æžæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ“¦ ä¾èµ–ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          pnpm list --depth=0 | grep -E "(dependencies|devDependencies)" -A 100 | head -20 >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸš¨ è¿‡æ—¶ä¾èµ–æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          pnpm outdated 2>/dev/null || echo "âœ… æ‰€æœ‰ä¾èµ–éƒ½æ˜¯æœ€æ–°çš„" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # ðŸ“‹ è´¨é‡æŠ¥å‘Š
  report:
    name: ðŸ“‹ è´¨é‡æŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: [analyze, lint, build-check, security, dependencies]
    if: always()
    steps:
      - name: ðŸ“‹ ç”Ÿæˆè´¨é‡æŠ¥å‘Š
        run: |
          echo "## ðŸ” ä»£ç è´¨é‡æ£€æŸ¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æ£€æŸ¥é¡¹ç›® | çŠ¶æ€ | è¯¦æƒ… |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“Š ä»£ç åˆ†æž | ${{ needs.analyze.result }} | ä»£ç ç»Ÿè®¡åˆ†æž |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” é™æ€åˆ†æž | ${{ needs.lint.result }} | ESLint + Prettier + TypeScript + Svelte |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª æž„å»ºéªŒè¯ | ${{ needs.build-check.result }} | æž„å»º + æ‰“åŒ…æµ‹è¯• |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”’ å®‰å…¨æ£€æŸ¥ | ${{ needs.security.result }} | Trivy æ¼æ´žæ‰«æ |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ˆ ä¾èµ–åˆ†æž | ${{ needs.dependencies.result }} | ä¾èµ–æ›´æ–°æ£€æŸ¥ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # è®¡ç®—é€šè¿‡çŽ‡
          PASSED=0
          TOTAL=5

          # ç›´æŽ¥åœ¨echoä¸­è®¡ç®—ï¼Œé¿å…bashå˜é‡é—®é¢˜
          if [ "${{ needs.analyze.result }}" = "success" ]; then PASSED=$((PASSED + 1)); fi
          if [ "${{ needs.lint.result }}" = "success" ]; then PASSED=$((PASSED + 1)); fi
          if [ "${{ needs.build-check.result }}" = "success" ]; then PASSED=$((PASSED + 1)); fi
          if [ "${{ needs.security.result }}" = "success" ]; then PASSED=$((PASSED + 1)); fi
          if [ "${{ needs.dependencies.result }}" = "success" ]; then PASSED=$((PASSED + 1)); fi

          PERCENTAGE=$((PASSED * 100 / TOTAL))

          echo "### ðŸ“Š è´¨é‡è¯„åˆ†: ${PERCENTAGE}%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$PERCENTAGE" -ge 80 ]; then
            echo "âœ… **ä»£ç è´¨é‡è‰¯å¥½** ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          elif [ "$PERCENTAGE" -ge 60 ]; then
            echo "âš ï¸ **ä»£ç è´¨é‡ä¸€èˆ¬ï¼Œéœ€è¦æ”¹è¿›**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ä»£ç è´¨é‡éœ€è¦é‡ç‚¹å…³æ³¨**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ æ‰§è¡Œç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
          echo "- **é€šè¿‡é¡¹ç›®**: $PASSED/$TOTAL" >> $GITHUB_STEP_SUMMARY
          echo "- **æ€»ä½“è¯„åˆ†**: ${PERCENTAGE}%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— ç›¸å…³é“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
          echo "- [è¯¦ç»†æŠ¥å‘Š](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- [é¡¹ç›®ä¸»é¡µ](${{ github.server_url }}/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY