name: ðŸš€ CI/CD Pipeline

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

env:
  PLUGIN_ID: git-zh
  PLUGIN_NAME: obsidian-git-zh

permissions:
  contents: write
  pull-requests: write

jobs:
  # ðŸ” ä»£ç è´¨é‡æ£€æŸ¥
  quality:
    name: ðŸ” ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ“¦ è®¾ç½® pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: ðŸ› ï¸ å®‰è£…ç³»ç»Ÿä¾èµ–
        run: sudo apt-get update && sudo apt-get install -y zip

      - name: ðŸ”§ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: ðŸ“š å®‰è£…ä¾èµ–
        run: pnpm install

      - name: ðŸ“ ç±»åž‹æ£€æŸ¥
        run: pnpm run tsc

      - name: ðŸ”Ž Svelte æ£€æŸ¥
        run: pnpm run svelte

      - name: ðŸ” ESLint æ£€æŸ¥
        run: pnpm run lint

      - name: ðŸ’… Prettier æ ¼å¼æ£€æŸ¥
        run: pnpm run format

  # ðŸ§ª æž„å»ºå’Œæµ‹è¯•
  build:
    name: ðŸ§ª æž„å»ºå’Œæµ‹è¯•
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ“¦ è®¾ç½® pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: ðŸ› ï¸ å®‰è£…ç³»ç»Ÿä¾èµ–
        run: sudo apt-get update && sudo apt-get install -y zip

      - name: ðŸ”§ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: ðŸ“š å®‰è£…ä¾èµ–
        run: pnpm install

      - name: ðŸ§ª å‘å¸ƒå‰æ£€æŸ¥
        run: pnpm run pre-release

      - name: ðŸ“¦ ç”Ÿæˆå‘å¸ƒåŒ…
        run: pnpm run package:obsidian

      - name: ðŸ“Š éªŒè¯å‘å¸ƒåŒ…
        run: |
          echo "ðŸ“¦ éªŒè¯å‘å¸ƒåŒ…ç»“æž„..."
          unzip -l git-zh.zip | grep -E "(${PLUGIN_ID}/|main.js|manifest.json|styles.css)" || exit 1
          echo "âœ… å‘å¸ƒåŒ…ç»“æž„éªŒè¯é€šè¿‡"

          echo ""
          echo "ðŸ“ å‘å¸ƒåŒ…å†…å®¹:"
          unzip -l git-zh.zip

      - name: ðŸ“¤ ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PLUGIN_NAME }}-build
          path: |
            dist/
            git-zh.zip
          retention-days: 7

  # ðŸš€ è‡ªåŠ¨å‘å¸ƒ (ä»…åœ¨pushåˆ°masteræ—¶)
  release:
    name: ðŸš€ è‡ªåŠ¨å‘å¸ƒ
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ“¦ è®¾ç½® pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: ðŸ› ï¸ å®‰è£…ç³»ç»Ÿä¾èµ–
        run: sudo apt-get update && sudo apt-get install -y zip

      - name: ðŸ”§ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: ðŸ“š å®‰è£…ä¾èµ–
        run: pnpm install

      - name: ðŸ“¦ ç”Ÿæˆæœ€æ–°å‘å¸ƒåŒ…
        run: |
          pnpm run package:obsidian
          cp git-zh.zip obsidian-git-zh-latest.zip

      - name: ðŸš€ æ›´æ–°æœ€æ–°Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          name: ðŸš€ Obsidian Git ä¸­æ–‡ç‰ˆ (æœ€æ–°æž„å»º)
          body: |
            ## ðŸŒŸ Obsidian Git ä¸­æ–‡ç‰ˆ - æœ€æ–°å¼€å‘æž„å»º

            âš ï¸ **è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨æž„å»ºç‰ˆæœ¬ï¼Œä»…ä¾›æµ‹è¯•ä½¿ç”¨**

            ### ðŸ“¦ ä¸‹è½½
            - [obsidian-git-zh-latest.zip](https://github.com/lyl224459/obsidian-git-zh/releases/download/latest/obsidian-git-zh-latest.zip)

            ### ðŸ“‹ æž„å»ºä¿¡æ¯
            - **æž„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
            - **æäº¤**: [`${{ github.sha }}`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
            - **åˆ†æ”¯**: `${{ github.ref_name }}`

            ### âš ï¸ æ³¨æ„äº‹é¡¹
            - è¿™ä¸æ˜¯æ­£å¼å‘å¸ƒç‰ˆæœ¬
            - å¯èƒ½åŒ…å«æœªæµ‹è¯•çš„åŠŸèƒ½
            - å»ºè®®ä»…ç”¨äºŽæµ‹è¯•ç›®çš„

            ---
            **æ­£å¼ç‰ˆæœ¬è¯·æŸ¥çœ‹ [Releases](https://github.com/lyl224459/obsidian-git-zh/releases)**
          draft: false
          prerelease: true
          files: obsidian-git-zh-latest.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ðŸ“Š æŠ¥å‘ŠçŠ¶æ€
  report:
    name: ðŸ“Š å·¥ä½œæµæŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: [quality, build, release]
    if: always()
    steps:
      - name: ðŸ“Š ç”ŸæˆæŠ¥å‘Š
        run: |
          echo "## ðŸš€ CI/CD Pipeline æ‰§è¡ŒæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š ä½œä¸šçŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” ä»£ç è´¨é‡æ£€æŸ¥: ${{ needs.quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ§ª æž„å»ºå’Œæµ‹è¯•: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš€ è‡ªåŠ¨å‘å¸ƒ: ${{ needs.release.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.quality.result }}" = "success" ] && [ "${{ needs.build.result }}" = "success" ]; then
            echo "### âœ… Pipeline æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "æ‰€æœ‰æ£€æŸ¥å’Œæž„å»ºæ­¥éª¤éƒ½å·²æˆåŠŸå®Œæˆï¼ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Pipeline å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "è¯·æ£€æŸ¥ä¸Šè¿°æ­¥éª¤çš„è¯¦ç»†æ—¥å¿—ã€‚" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— ç›¸å…³é“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ“¦ æž„å»ºäº§ç‰©](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ“‹ é¡¹ç›®ä¸»é¡µ](${{ github.server_url }}/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY