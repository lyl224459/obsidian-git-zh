name: æ„å»ºæµ‹è¯•ï¼ˆä¸­æ–‡ç‰ˆï¼‰

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  build:
    name: ğŸ”¨ æ„å»ºæµ‹è¯•
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ è®¾ç½® pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: ğŸ”§ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: ğŸ“š å®‰è£…ä¾èµ–
        run: pnpm install

      - name: ğŸ”¨ æ„å»ºé¡¹ç›®
        run: |
          echo "ğŸ”¨ æ„å»º Obsidian Git ä¸­æ–‡ç‰ˆ..."
          pnpm run build
          echo "âœ… æ„å»ºå®Œæˆï¼"

      - name: ğŸ“Š éªŒè¯æ„å»º
        run: |
          echo "ğŸ“¦ æ£€æŸ¥æ„å»ºæ–‡ä»¶..."
          test -f dist/main.js && echo "âœ… main.js å­˜åœ¨" || exit 1
          test -f dist/manifest.json && echo "âœ… manifest.json å­˜åœ¨" || exit 1
          test -f dist/styles.css && echo "âœ… styles.css å­˜åœ¨" || exit 1
          
          echo ""
          echo "ğŸ“ æ–‡ä»¶å¤§å°:"
          ls -lh dist/
          
          echo ""
          echo "âœ… æ‰€æœ‰æ„å»ºæ–‡ä»¶éªŒè¯é€šè¿‡ï¼"

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: obsidian-git-zh-build
          path: dist/
          retention-days: 7

  lint:
    name: ğŸ” ä»£ç æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ è®¾ç½® pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: ğŸ”§ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: ğŸ“š å®‰è£…ä¾èµ–
        run: pnpm install

      - name: ğŸ” ESLint æ£€æŸ¥
        run: pnpm run lint
        continue-on-error: true

      - name: ğŸ’… Prettier æ ¼å¼æ£€æŸ¥
        run: pnpm run format
        continue-on-error: true

  type-check:
    name: ğŸ“ ç±»å‹æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ è®¾ç½® pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: ğŸ”§ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: ğŸ“š å®‰è£…ä¾èµ–
        run: pnpm install

      - name: ğŸ” Svelte æ£€æŸ¥
        run: pnpm run svelte
        continue-on-error: true
